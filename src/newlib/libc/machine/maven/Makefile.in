#=========================================================================
# Makefile for maven newlib libc machine directory
#=========================================================================
# This makefile builds a maven version of the libc machine specific
# files. Currently there is no support for multilib. Note that the mips
# machine directory includes custom versions of strcmp, strlen, strncpy,
# memset, and memcpy. We don't use those version since we don't support
# unaligned accesses and the default versions (located in
# xcc/src/newlib/libc/string seem good enough). If you wanted custom
# versions of these functions ideally you would put them in this
# directory, but be aware that I was having trouble since I think this
# ultimately results in these functions being included in libc twice.
# I'm not sure how to "override" the default implementations.

#-------------------------------------------------------------------------
# Source files
#-------------------------------------------------------------------------

maven_hdrs = \
  machine/regdef.h \
  machine/setjmp.h \
  machine/time.h \

maven_srcs = \
  setjmp.S \

#-------------------------------------------------------------------------
# Basic setup
#-------------------------------------------------------------------------

# Remove all default implicit rules since they can cause subtle bugs
# and they just make things run slower

.SUFFIXES:
% : %,v
% : RCS/%,v
% : RCS/%
% : s.%
% : SCCS/s.%

# Default is to build the prereqs of the all target (defined at bottom)

default : all
.PHONY : default

# Source directory

obj_dir := .
src_dir := @srcdir@
VPATH   := $(src_dir)

# Installation directories

prefix  := @prefix@
DESTDIR ?= $(prefix)

install_hdrs_dir := $(DESTDIR)$(prefix)/$(target_alias)/include/machine
install_libs_dir := $(DESTDIR)$(prefix)/$(target_alias)/lib

#-------------------------------------------------------------------------
# Programs and flags 
#-------------------------------------------------------------------------

# C compiler

CC            := @CC@
CFLAGS        := @CFLAGS@
CPPFLAGS      := -I$(obj_dir) -I$(src_dir)
COMPILE       := $(CC) -MMD -MP $(CPPFLAGS) $(CFLAGS)

# Library creation

AR            := @AR@
RANLIB        := @RANLIB@

# Installation

MKINSTALLDIRS := $(src_dir)/mk-install-dirs.sh
INSTALL       := @INSTALL@
INSTALL_HDR   := $(INSTALL) -m 444
INSTALL_LIB   := $(INSTALL) -m 644

#-------------------------------------------------------------------------
# Build Object Files from C Source
#-------------------------------------------------------------------------

maven_c_srcs = $(filter %.c, $(maven_srcs))
maven_c_objs = $(patsubst %.c, %.o, $(maven_c_srcs))
maven_c_deps = $(patsubst %.c, %.d, $(maven_c_srcs))

$(maven_c_objs) : %.o : %.c
	$(COMPILE) -c $<

objs += $(maven_c_objs)
deps += $(maven_c_deps)
junk += $(maven_c_deps) $(maven_c_objs)

#-------------------------------------------------------------------------
# Build Object Files from Assembly Source
#-------------------------------------------------------------------------

maven_asm_srcs = $(filter %.S, $(maven_srcs))
maven_asm_objs = $(patsubst %.S, %.o, $(maven_asm_srcs))
maven_asm_deps = $(patsubst %.S, %.d, $(maven_asm_srcs))

$(maven_asm_objs) : %.o : %.S
	$(COMPILE) -c $<

objs += $(maven_asm_objs)
deps += $(maven_asm_deps)
junk += $(maven_asm_deps) $(maven_asm_objs)

#-------------------------------------------------------------------------
# Build lib.a
#-------------------------------------------------------------------------

lib_a = lib.a
$(lib_a) : $(objs)
	$(AR) rcv $@ $^
	$(RANLIB) $@

junk += $(lib_a)
install_libs += $(lib_a)

#-------------------------------------------------------------------------
# Autodependency files
#-------------------------------------------------------------------------

-include $(deps)

deps : $(deps)
.PHONY : deps

#-------------------------------------------------------------------------
# Installation
#-------------------------------------------------------------------------

install_hdrs_wdir += $(addprefix $(src_dir)/, $(maven_hdrs))
install-hdrs : $(install_hdrs_wdir)
	$(MKINSTALLDIRS) $(install_hdrs_dir)
	for file in $^; do \
    $(INSTALL_HDR) $$file $(install_hdrs_dir); \
  done

install-libs : $(install_libs)
	$(MKINSTALLDIRS) $(install_libs_dir)
	for file in $^; do \
    $(INSTALL_LIB) $$file $(install_libs_dir); \
  done

install : install-hdrs install-libs 
.PHONY : install install-hdrs install-libs

#-------------------------------------------------------------------------
# Regenerate configure information
#-------------------------------------------------------------------------

configure_prereq = \
  $(src_dir)/configure.ac \

$(src_dir)/configure : $(configure_prereq)
	cd $(src_dir) && autoconf

config.status : $(src_dir)/configure
	./config.status --recheck

Makefile : $(src_dir)/Makefile.in config.status
	./config.status

dist_junk += config.status Makefile config.log

#-------------------------------------------------------------------------
# Default
#-------------------------------------------------------------------------

all : $(install_libs)
.PHONY : all

#-------------------------------------------------------------------------
# Clean up junk
#-------------------------------------------------------------------------

clean :
	rm -rf *~ \#* $(junk)

distclean :
	rm -rf *~ \#* $(junk) $(dist_junk)

.PHONY : clean distclean
